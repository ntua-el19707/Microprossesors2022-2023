.include "m328PBdef.inc"
.org 0x00
    jmp reset
.org  0x2A ;ADC Conversion complete Interrupt
     push r21
     push r20
     lds r20,ADCL
     lds r21,ADCH 
     ;10bit
     ;pd9 pd8 r20 pd7 pg6 pd5 pd4 pd3   pd2  pd1 p0   
     rcall bountry_70 ;
     out PORTB,r16
     endroutine:
     pop r21
     pop r20
    reti
    
   
reset:
;eisosodos ac3 0011
    ldi r24,high(RAMEND)
    out SPH,r24
    ldi r24,low(RAMEND)
    out SPL,r24 ;set stack  initializations 
    ldi r24,0x23 ; ADLAR : right adustment agustmeny REF:01 vref =5V mode ADC0 0000
    sts ADMUX,r24 
    ldi r24,0x8F
    sts ADCSRA,r24 
    ldi r24,0x3F ;
    out DDRB,r24 ; set pB0 - pB5 outputs    
    
    
    ;r16 -level
    clr r16
    clr r17 ;r17 used for determait what too dipalyed in lcd 
start:
    sbi PORTD ,PIND3
        lds r24, ADCSRA ;	
        ori r24, (1<<ADSC) ; Set ADSC flag of ADCSRA
        sts ADCSRA, r24
	wait_adc:
	    lds r24,ADCSRA 
	   ;   andi r24,0xBF
	   ; sts ADCSRA, r24
	    sbrc r24,ADSC
	    rjmp wait_adc
	;delay 
	; => routine 
	;delay(2ms)
	ldi r24,low(2)
	ldi r25,high(2) ;wait 2ms
	rcall wait_msec
        display:
	
            cpi r16,0
	    brne maycleared
    	    rcall lcd_init ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'G' 
	     rcall lcd_data ; 
              
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'A' 
	     rcall lcd_data ; 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'S' 
	     rcall lcd_data ; 
	 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,' ' 
	     rcall lcd_data ; 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'D'
	       rcall lcd_data ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'E'
	     rcall lcd_data ;  ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'T'
	      rcall lcd_data ;  ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'E'
	    rcall lcd_data ;  ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'C'
	     rcall lcd_data ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'T'
	       rcall lcd_data ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'E'
	      rcall lcd_data ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'D' 
	     rcall lcd_data ; 
	    maycleared:
    	    rcall lcd_init ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'C' 
	     rcall lcd_data ; 
              
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'L' 
	     rcall lcd_data ; 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'E' 
	     rcall lcd_data ; 
	 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'A' 
	     rcall lcd_data ; 
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'R'
	       rcall lcd_data ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'E'
	     rcall lcd_data ;  ; ???????????? ??????
	    ldi r24, low(2)
	    ldi r25, high(2) ; ??????? 2 msec
	    rcall wait_msec
            ldi r24,'D'
	    rcall lcd_data ;  ???????????? ??????
	    
    ldi r24 ,88 ; 
ldi r25 ,0 ;
rcall wait_msec ;
	     
	    
        
        ;delay prin + now 100msec
        jmp start
    
bountry_70:
    push r22
    push r20
    push r21
    cpi r20,70
    brlo endb_70
    ldi r16,0x01 ;level
   
    ldi r22,150 ; 
    rcall bountry ;level 2
    ldi r22,255 ; 
    rcall bountry ;level 3
    rcall bountry_above
    endb_70:
    pop r21
    pop r20
    pop r22
    ret 
bountry:
    cp r20,r22
    brlo endbo
    lsr r16
    endbo:
    ret
bountry_above:
    cpi r21,0
    breq exit_ba
    cpi r21,0x01
    brne nextcpi1
    ldi r16,0x08 ;level 4 
    rjmp exit_ba
    nextcpi1:
    cpi r21,0x02
    brne nextcpi2
    ldi r16,0x10 ;level 5 
    rjmp exit_ba
    nextcpi2:
    cpi r21,0x03
    brne exit_ba
    ldi r16,0x20 ;level 5 
    exit_ba:
    ret
    
    
	write_2_nibbles:
	    push r24 ; ??????? ?? 4 MSB
	    in r25 ,PIND ; ??????????? ?? 4 LSB ??? ?? ?????????????
	    andi r25 ,0x0f ; ??? ?? ??? ????????? ??? ????? ??????????? ?????????
	    andi r24 ,0xf0 ; ????????????? ?? 4 MSB ???
	    add r24 ,r25 ; ???????????? ?? ?? ???????????? 4 LSB
	    out PORTD ,r24 ; ??? ???????? ???? ?????
	    sbi PORTD ,PIND3;  ????????????? ?????? Enable ???? ????????? PD3
	    cbi PORTD ,PIND3 ; PD3=1 ??? ???? PD3=0
	    pop r24 ; ??????? ?? 4 LSB. ????????? ?? byte.
	    swap r24 ; ????????????? ?? 4 MSB ?? ?? 4 LSB
	    andi r24 ,0xf0 ; ??? ?? ??? ????? ???? ?????????????
	    add r24 ,r25
	    out PORTD ,r24
	    sbi PORTD ,PIND3 ; ???? ?????? Enable
	    nop 
	    nop
	    cbi PORTD ,PIND3
	    nop
	    nop
            ret
	    lcd_data:
		sbi PORTD ,PIND2 ; ??????? ??? ?????????? ????????? (PD2=1)
		rcall write_2_nibbles ; ???????? ??? byte
		ldi r24 ,43 ; ??????? 43?sec ????? ?? ??????????? ? ????
		ldi r25 ,0 ; ??? ????????? ??? ??? ??????? ??? lcd
		rcall wait_usec	
		ret
            
            lcd_command:
		cbi PORTD ,PIND2 ; ??????? ??? ?????????? ??????? (PD2=1)
		rcall write_2_nibbles ; ???????? ??? ??????? ??? ??????? 39?sec
		ldi r24 ,39 ; ??? ??? ?????????? ??? ????????? ??? ??? ??? ??????? ??? lcd.
		ldi r25 ,0 ; ???.: ???????? ??? ???????, clear display ??? return home,
		rcall wait_usec ; ??? ???????? ????????? ?????????? ??????? ????????.
		ret
	lcd_init:
ldi r24 ,40 ; ???? ? ???????? ??? lcd ????????????? ??
ldi r25 ,0 ; ????? ??????? ??? ???? ??? ????????????.
rcall wait_msec ; ??????? 40 msec ????? ???? ?? ???????????.
ldi r24 ,0x30 ; ?????? ????????? ?? 8 bit mode
out PORTD ,r24 ; ?????? ??? ???????? ?? ??????? ???????
 sbi PORTD ,PIND3;?? ?? ?????????? ??????? ??? ???????
cbi PORTD ,PIND3 ; ??? ??????, ? ?????? ???????????? ??? ?????
ldi r24 ,39
ldi r25 ,0 ; ??? ? ???????? ??? ?????? ????????? ?? 8-bit mode
rcall wait_usec ; ??? ?? ?????? ??????, ???? ?? ? ???????? ???? ??????????
 ; ??????? 4 bit ?? ??????? ?? ?????????? 8 bit
 ldi r24 ,0x30
out PORTD ,r24
 sbi PORTD ,PIND3
cbi PORTD ,PIND3
ldi r24 ,39
ldi r25 ,0
rcall wait_usec
ldi r24 ,0x20 ; ?????? ?? 4-bit mode
out PORTD ,r24
 sbi PORTD ,PIND3
cbi PORTD ,PIND3
ldi r24 ,39
ldi r25 ,0
rcall wait_usec
 ldi r24 ,0x28 ; ??????? ?????????? ???????? 5x8 ????????
 rcall lcd_command ; ??? ???????? ??? ??????? ???? ?????
ldi r24 ,0x0c ; ???????????? ??? ??????, ???????? ??? ???????
 rcall lcd_command
 ldi r24 ,0x01 ; ?????????? ??? ??????
rcall lcd_command
ldi r24 ,low(1530)
ldi r25 ,high(1530)
rcall wait_usec
 ldi r24 ,0x06 ; ???????????? ????????? ??????? ???? 1 ??? ??????????
rcall lcd_command ; ??? ????? ???????????? ???? ??????? ??????????? ???
 ; ?????????????? ??? ????????? ????????? ??? ??????
ret
stall7:
    
    ret
wait_msec:
    push r24 ;
    push r25 ;
    push r26
    push r27 ; 8 + 3 = 
    loopmsec:
        sbiw r24,0x01 ; 2
	movw r26,r24 ;  3 
	ldi r24,low(997) ;
	ldi r25,high(997) ;5
	rcall wait_usec ; 
	movw r24,r26 ;6
	cp r24,r25 ; 7
	breq contition2 ;8
        ;8
	rcall stall7
	rcall stall7
	rcall stall7
	rcall stall7
	rcall stall7
	nop
	nop
	jmp loopmsec ; 1000usec
	contition2:
        ;9
	cpi r24,0
	breq endloopmsec
	;11 failed
	;stall 21
	rcall stall7
        rcall stall7
	rcall stall7
	rcall stall7
	nop
	nop
	nop
	nop
	nop
	nop
	jmp loopmsec
	
    endloopmsec:
    ;12 
    rcall stall7 ;7 i need 6 more
    jmp eatpls3     
    eatpls3:
    jmp eatpls32
    eatpls32:
    pop r27
    pop r26
    pop r25 ;
    pop r24 ;
    ret ; 23usec
wait_usec:
    ;clock 16MHZ
    ;16cycles = 1ms  ;
    push r24;
    push r25 ; 4 + 3 calesma =  7
    loopu:
    sbiw r24,0x01 ; 2 
    cpi r24,0x01 ;  1 
    breq maystop ; 
    ;4 cycles  anonther 12
    jmp nonstop1 ; 3
    nonstop1:
    jmp nonstop2 ;3
    nonstop2:
    jmp nonstop3 ;3
    nonstop3:
    jmp loopu ; 3 +9 + 4 =16
    maystop:
    ;5 another 11
    cpi r25,0x0 ;1
    breq endloop ; 1
    ;failed 7
    ;16 -7  = 9
    jmp nonstop4 
    nonstop4:
    jmp nonstop5
    nonstop5:
    jmp loopu
    endloop:
    ;8 + 8
    jmp nonstop6
    nonstop6:
    jmp nonstop7
    nonstop7:
    nop
    nop
    nop
    pop r25 ; 4+4 =8 +7(begin) = 15 +nop =16 1us
    pop r24 ;
    ret ;
    